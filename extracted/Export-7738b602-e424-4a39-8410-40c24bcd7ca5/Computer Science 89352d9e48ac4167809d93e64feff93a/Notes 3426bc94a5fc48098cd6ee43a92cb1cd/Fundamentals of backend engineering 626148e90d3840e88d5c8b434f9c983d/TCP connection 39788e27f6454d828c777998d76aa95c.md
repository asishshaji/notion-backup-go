# TCP connection

[](https://levelup.gitconnected.com/deep-dive-into-tcp-connection-establishment-process-f6cfb7b4e8e1)

A server must run at least one socket to accept client connections. When a client sends a connection request, the server’s listening socket reads it and the kernel creates a new socket. This socket is called the connection socket.

The server application source code must have access to this socket descriptor for reading and writing data from and to the client. 

TCP stack receives a stream of bytes and converts them into chunks known as TCP segments. Its size is agreed upon during a connection establishment. It’s known as MSS (Maximum Segment Size). 

The client can suggest its own MSS in the syn packet, but ultimately it’s up to the server to select the MSS. Generally, it doesn't choose a value greater than the client's proposed. This value is then communicated back to the client in the syn-ack packet.

Each TCP segment contains a sequence number, the first byte in the segment. The sequence numbers are chosen randomly by both sides during the three-way handshake. Each side generates its own sequence number, sends it to a counterpart, and waits for an acknowledgement.

![Untitled](TCP%20connection%2039788e27f6454d828c777998d76aa95c/Untitled.png)

When a host receives a sequence number generated by the other side, it simply increments it and lacks the value. 

After the three-way handshake is established only the initiating host sends the sequence number, the receiving side just acknowledges them.

![Untitled](TCP%20connection%2039788e27f6454d828c777998d76aa95c/Untitled%201.png)

## What happens during a connection

![Untitled](TCP%20connection%2039788e27f6454d828c777998d76aa95c/Untitled%202.png)

When a syn packet arrives, the kernel creates a connection request and saves it in a queue called the syn queue or connection request queue, a half-open connection queue.

When the server receives the ack packet, the connection request is moved from the syn queue and a connection socket is created which is placed on the accept queue or backlog queue, pending connection queue.

The server application code calling the accept() system call can move the connection from the accept queue.

### Syncookies

![Untitled](TCP%20connection%2039788e27f6454d828c777998d76aa95c/Untitled%203.png)

Almost all of the data of a connection request can be obtained from the ack processing step, except the MSS value. The MSS value is only sent in the syn packet.

However, TCP does the following. When a receiving host processes a syn packet, it extracts an MSS value, clamps it to a user-defined value if set, and encodes it in a sequence number which is sent back to a sending host in a syn-ack packet. The sending host acknowledges a syn-ack packet just the same way: it increments the receiving host’s sequence number and sends it in an ack packet. The receiving host extracts an MSS value from it and calculates a final result.

This mechanism can be either totally disabled, or enabled only when a connection request queue is full, or always used, regardless of the connection request queue state.

SYN cookies are a technical attack mitigation technique whereby the server replies to TCP SYN requests with crafted SYN-ACKs, without inserting a new record into its SYN Queue. Only when the client replies to this crafted response a new record is added. This technique is used to protect the server SYN Queue from filling up under TCP SYN floods.

![The three-way handshake with syncookies enabled](TCP%20connection%2039788e27f6454d828c777998d76aa95c/Untitled%204.png)

The three-way handshake with syncookies enabled

[Dive into the source code](TCP%20connection%2039788e27f6454d828c777998d76aa95c/Dive%20into%20the%20source%20code%203c975f92753c4a82a336f583aaffc5af.md)