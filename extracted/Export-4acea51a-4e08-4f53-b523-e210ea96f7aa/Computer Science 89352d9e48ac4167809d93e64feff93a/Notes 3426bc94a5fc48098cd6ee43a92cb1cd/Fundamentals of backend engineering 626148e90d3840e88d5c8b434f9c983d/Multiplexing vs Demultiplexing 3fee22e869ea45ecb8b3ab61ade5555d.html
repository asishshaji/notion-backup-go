<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Multiplexing vs Demultiplexing</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="3fee22e8-69ea-45ec-b8b3-ab61ade5555d" class="page mono"><header><h1 class="page-title">Multiplexing vs Demultiplexing</h1><p class="page-description"></p></header><div class="page-body"><p id="772c3622-7abd-438b-b233-0de30214eae3" class="">Multiplexing is combining multiple TCP connections into one. Demultiplexing is the opposite. The issue with this is that chrome can only open at most 6 connections at a time. So this becomes a bottleneck. </p><p id="3cd72c80-31b4-4b66-aa44-a032b7db465c" class="">Http/1 requires multiple TCP connections for multiple requests.</p><p id="5245be81-b345-4343-99a0-f8d67e8ea149" class="">But in Http/2 multiple requests can be combined into a single TCP connection. These multiple connections are essentially multiplexed into single connection. </p><figure id="d1151a9a-b8ae-4109-b427-404e47ac69f6" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled.png"><img style="width:720px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled.png"/></a></figure><figure id="c7ccde8b-6885-4830-9d90-77a1a7c6fe50" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%201.png"><img style="width:720px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%201.png"/></a></figure><p id="9a4c4b5a-3d46-4aeb-b24a-e189ae3c99af" class="">In the above figure, multiple http/1 requests are combined into a single http/2 connection by the proxy. The downside is that it puts lot of load on the http/2 server. The end server need to parse the single request and separate it back to three request.</p><figure id="65a618ed-4c15-4c1b-97f8-d5ced496be4b" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%202.png"><img style="width:720px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%202.png"/></a></figure><p id="21ce4df2-defb-402b-ba9d-b622d17ef07b" class="">This figure is just the opposite.</p><h2 id="64d4dfb0-a1e0-4e7b-9f61-5b40d359083c" class="">Connection Pooling</h2><figure id="531112f0-12e6-4012-a08d-db3d0db73302" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%203.png"><img style="width:720px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%203.png"/></a></figure><p id="07d61a18-d6b4-4409-8c9c-8d154f774698" class="">We will have a pool of connections open to database server from backend server. When a request comes from the client we will assign the connection which is free to that request instead of creating new one.</p><figure id="479a5a6e-117a-412c-8ef6-dad8436e0a50" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%204.png"><img style="width:720px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%204.png"/></a></figure><p id="53d2b08c-5d85-4302-94d2-7ad102988e00" class="">Lets say the max open connection is 4. Now all of them are busy. The new request is blocked. When one of the database connection is free new connection is accepted by the database.  </p><h3 id="a4f02183-a0e3-4711-8e34-c16d36319326" class=""><strong>What is the problem with normal connections?</strong></h3><p id="40e83550-7b1f-41a9-ae03-659e468f5e59" class="">Assume we have a Postgres database and you want to run this query on it.</p><p id="ae1cea8a-6cb7-4edd-8545-ed47d68dee22" class=""><code>select chairs from dining_table;</code></p><p id="0cb5f470-433f-4158-8223-68bdbbaaff41" class="">To get the result, along with this query we need to provide the database details and our authentication details, usually the <em>host, port, database, username and password</em>. These are needed because before actually running the query, the program has to:</p><p id="4a6edd2a-aa73-4fae-9451-414b8a331b7b" class="">→ find the database → connect to it → authenticate our connection → use the given database → and then run our query.</p><p id="3cde1445-7100-49a5-9d45-63a14851ec87" class="">Once the result is returned the connection is closed. When we want to run a different query we need to start over again.</p><p id="66e5fe30-2ed2-4051-ac97-17e91fe24a7e" class="">As you can see we this is time consuming. Authentication is a very expensive process and most of the times creating connections take relatively more time compared to the actual query they run. So it becomes very inefficient for us to create a connection for every query.</p><p id="568be8ae-c26d-49d1-bc85-d48b4c3e4fe9" class="">So instead of closing the connection, keeping it active and running all the queries using the same connection gets rid of the creation latency. But in a service, how do we share a connection between different clients? That is where connection pooling comes in.</p><p id="877a58d1-87e5-4372-a8b7-ad3d03d246ea" class="">Connection Pooling alleviates this problem by creating a pool of connections at the start and keeping them alive (ie not closing the connections) till the end.</p><figure id="2374eac8-ee76-463a-a72d-60ce71830070" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%205.png"><img style="width:768px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%205.png"/></a></figure><p id="ce32ed0e-8dd0-4246-a871-5bdaea1ba5e5" class="">Whenever some part of the application wants to query the database, they borrow the connection from the pool and once they are done with the query instead of closing the connection, it is returned back to the pool.</p><p id="9f6a5cba-be87-4131-82dd-e695379ffddc" class="">If all connections are used up, the pool will do a blocking wait on new requests, and once a connection is free let the newer request through. To our program, this mostly looks like a longer query than normal.</p><h3 id="663a9b86-8c4e-4594-9ef6-eff638453300" class=""><strong>What does this look like in code?</strong></h3><p id="dd104393-3486-4fbb-b5dd-c968ee7dd04d" class="">Often in Go you will see the pattern of a *DB being created in the main function, or at least a function is called that creates it. This instance is then passed to each data layer entity or service for use. Usually as part of a struct for a service. This means that it acts as a singleton, each request that comes in is using the same database pool. That is an important part here, <strong>each incoming request is using the same DB instance.</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ef962055-d32f-48f6-aba3-794336e3069e" class="code"><code class="language-Go" style="white-space:pre-wrap;word-break:break-all">package main

import (
	&quot;context&quot;
	&quot;database/sql&quot;
	&quot;flag&quot;
	&quot;fmt&quot;
	&quot;github.com/gorilla/mux&quot;
	&quot;github.com/kohofinancial/go-and-databases/services&quot;
	_ &quot;github.com/lib/pq&quot;
	&quot;log&quot;
	&quot;net/http&quot;
	&quot;time&quot;
)

type app struct {
	UserService services.UserService
}

func main() {
	var dsn string
	var port string
	var setLimits bool
	flag.StringVar(&amp;dsn, &quot;dsn&quot;, &quot;&quot;, &quot;PostgreSQL DSN&quot;)
	flag.StringVar(&amp;port, &quot;port&quot;, &quot;8080&quot;, &quot;Service Port&quot;)
	flag.BoolVar(&amp;setLimits, &quot;limits&quot;, false, &quot;Sets DB limits&quot;)
	flag.Parse()

	db, err := openDB(dsn, setLimits)
	if err != nil {
		log.Fatalln(err)
	}
	defer func(db *sql.DB) {
		err := db.Close()
		if err != nil {
			log.Fatalln(err)
		}
	}(db)

	application := app{UserService: services.NewPostgresUserService(db)}

	r := mux.NewRouter()
	userRouter := r.PathPrefix(&quot;/users&quot;).Subrouter()
	userRouter.HandleFunc(&quot;/{id}&quot;, application.GetUser).Methods(http.MethodGet)
	userRouter.HandleFunc(&quot;&quot;, application.AddUser).Methods(http.MethodPost)

	http.Handle(&quot;/&quot;, r)
	log.Fatal(http.ListenAndServe(fmt.Sprintf(&quot;:%s&quot;, port), nil))
}

func openDB(dsn string, setLimits bool) (*sql.DB, error) {
	db, err := sql.Open(&quot;postgres&quot;, dsn)
	if err != nil {
		return nil, err
	}

	if setLimits {
		fmt.Println(&quot;setting limits&quot;)
		db.SetMaxOpenConns(5)
		db.SetMaxIdleConns(5)
	}

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	err = db.PingContext(ctx)
	if err != nil {
		return nil, err
	}

	return db, nil
}</code></pre><p id="f387521a-3d21-4955-80f0-2c053f82af13" class="">I think you can see why it is great that Go does pooling on its own. By creating a single instance of the DB pool Go can make as many connections it deems necessary based on load.</p><h2 id="64a5f8f7-34f2-4cac-8808-b2e36c6fbe37" class="">Browser demultiplexing</h2><figure id="0c0747af-6f4d-45a1-a61f-7593f082326d" class="image" style="text-align:left"><a href="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%206.png"><img style="width:576px" src="Multiplexing%20vs%20Demultiplexing%203fee22e869ea45ecb8b3ab61ade5555d/Untitled%206.png"/></a></figure><p id="220fa7cd-be52-4a77-8d77-485ca6756de8" class="">6 connections here represents the max no of connections that chrome browser can make. Up to 6 connections in HTTP/1.1, after that requests are blocked.</p><p id="28cd611d-ef62-42ff-9013-30af925d5f04" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>